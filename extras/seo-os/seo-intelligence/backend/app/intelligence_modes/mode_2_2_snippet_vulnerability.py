"""
MODE 2.2: Featured Snippet Vulnerability Scanner
Identifies keywords where you rank 2-5 with NO featured snippet = easy win opportunity
"""

from typing import Dict, List, Any
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, and_

from app.models.uploads import OrganicKeyword, Upload, SERPOverview
from app.core.ai_engine import AIEngine


class SnippetVulnerabilityScanner:
    """
    Finds position #2-5 rankings where no featured snippet exists
    These are "position zero opportunities" - easy wins
    """

    def __init__(self, session: AsyncSession, user_id: str):
        self.session = session
        self.user_id = user_id
        self.ai_engine = AIEngine()

    async def execute(self) -> Dict[str, Any]:
        """
        Execute featured snippet vulnerability analysis
        """

        # Step 1: Get your keywords ranking position 2-5
        candidate_keywords = await self._get_position_2_5_keywords()

        if not candidate_keywords:
            return {
                "error": "No keywords found where you rank position 2-5. Upload Organic Keywords report."
            }

        # Step 2: Check SERP data for each keyword
        opportunities = []
        blocked_by_snippet = []

        for kw in candidate_keywords:
            snippet_status = await self._check_snippet_status(kw['keyword'])

            if snippet_status['has_snippet']:
                blocked_by_snippet.append({
                    **kw,
                    'snippet_owner': snippet_status['snippet_owner'],
                    'snippet_position': snippet_status['snippet_position'],
                })
            else:
                # OPPORTUNITY: No snippet exists
                opportunities.append({
                    **kw,
                    'opportunity_score': self._calculate_opportunity_score(kw),
                })

        # Step 3: Sort by opportunity score
        opportunities.sort(key=lambda x: x['opportunity_score'], reverse=True)

        # Step 4: Generate AI insight
        ai_insight = await self._generate_ai_insight(opportunities[:20])

        return {
            "mode": "2.2_snippet_vulnerability",
            "status": "completed",
            "summary": {
                "total_position_2_5": len(candidate_keywords),
                "snippet_opportunities": len(opportunities),
                "blocked_by_snippet": len(blocked_by_snippet),
                "estimated_traffic_potential": sum(o['traffic'] for o in opportunities),
            },
            "snippet_opportunities": opportunities[:50],
            "blocked_keywords": blocked_by_snippet[:20],
            "ai_insight": ai_insight,
        }

    async def _get_position_2_5_keywords(self) -> List[Dict]:
        """
        Get your keywords ranking position 2-5
        """
        query = (
            select(OrganicKeyword)
            .join(Upload, OrganicKeyword.upload_id == Upload.id)
            .where(Upload.user_id == self.user_id)
            .where(Upload.is_primary == True)
            .where(Upload.processing_status == "completed")
            .where(OrganicKeyword.position.isnot(None))
            .where(OrganicKeyword.position.between(2, 5))
            .where(OrganicKeyword.volume.isnot(None))
        )

        result = await self.session.execute(query)
        rows = result.scalars().all()

        keywords = []
        for kw_obj in rows:
            keywords.append({
                "keyword": kw_obj.keyword,
                "position": kw_obj.position,
                "volume": kw_obj.volume or 0,
                "traffic": kw_obj.traffic or 0,
                "url": kw_obj.url,
                "parent_topic": kw_obj.parent_topic,
                "difficulty": kw_obj.difficulty,
            })

        return keywords

    async def _check_snippet_status(self, keyword: str) -> Dict:
        """
        Check if this keyword has a featured snippet in SERP
        """
        query = (
            select(SERPOverview)
            .join(Upload, SERPOverview.upload_id == Upload.id)
            .where(Upload.user_id == self.user_id)
            .where(Upload.processing_status == "completed")
            .where(SERPOverview.keyword == keyword)
            .where(SERPOverview.position == 0)  # Featured snippet is position 0
        )

        result = await self.session.execute(query)
        snippet = result.scalars().first()

        if snippet:
            return {
                'has_snippet': True,
                'snippet_owner': snippet.domain,
                'snippet_position': 0,
                'snippet_type': snippet.result_type,
            }
        else:
            return {
                'has_snippet': False,
                'snippet_owner': None,
                'snippet_position': None,
            }

    def _calculate_opportunity_score(self, keyword: Dict) -> float:
        """
        Calculate opportunity score (0-100)

        Higher score = better opportunity
        Factors:
        - Search volume (higher = better)
        - Current position (higher position = easier to jump)
        - Traffic potential
        """
        score = 0

        # Volume component (max 40 points)
        volume = keyword.get('volume', 0)
        if volume >= 5000:
            score += 40
        elif volume >= 2000:
            score += 30
        elif volume >= 1000:
            score += 20
        elif volume >= 500:
            score += 10
        else:
            score += 5

        # Position component (max 30 points)
        # Position 2 = easiest to jump to #0
        position = keyword.get('position', 5)
        if position == 2:
            score += 30
        elif position == 3:
            score += 25
        elif position == 4:
            score += 20
        elif position == 5:
            score += 15

        # Traffic potential (max 30 points)
        traffic = keyword.get('traffic', 0)
        if traffic >= 500:
            score += 30
        elif traffic >= 200:
            score += 20
        elif traffic >= 100:
            score += 15
        elif traffic >= 50:
            score += 10
        else:
            score += 5

        return score

    async def _generate_ai_insight(self, opportunities: List[Dict]) -> Dict:
        """
        Generate AI recommendations for snippet optimization
        """

        if not opportunities:
            prompt = "No featured snippet opportunities found. User ranks well but snippets already exist."
        else:
            top_opportunities = "\n".join([
                f"- \"{o['keyword']}\" (Pos {o['position']}, Vol {o['volume']}, Score {o['opportunity_score']:.0f})"
                for o in opportunities[:10]
            ])

            prompt = f"""
Analyze these featured snippet opportunities:

TOP OPPORTUNITIES:
{top_opportunities}

These keywords:
- You currently rank position 2-5
- NO featured snippet currently exists
- High traffic potential

Provide:

1. SNIPPET OPTIMIZATION STRATEGY
   - How to optimize for featured snippets?
   - What content formats win snippets? (lists, tables, paragraphs, etc.)

2. TOP 5 IMMEDIATE WINS
   - Which keywords to optimize first?
   - Specific formatting recommendations for each

3. CONTENT OPTIMIZATION TACTICS
   - How to restructure existing content for snippet capture?
   - What markup/schema to add?
   - Ideal answer length and format?

4. ONGOING STRATEGY
   - How to systematically optimize for snippets?
   - How to monitor snippet wins?

Be specific about formatting, structure, and content changes needed.
            """

        ai_result = await self.ai_engine.generate_insight(
            prompt=prompt,
            mode="snippet_vulnerability",
            use_complex_model=False  # Sonnet is fine for tactical optimization
        )

        return ai_result
