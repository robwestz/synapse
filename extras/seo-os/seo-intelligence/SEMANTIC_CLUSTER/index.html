<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entity & Cluster Intelligence v3.0 | APEX</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-card: #1e1e2a;
            --text-primary: #f0f0f5;
            --text-secondary: #8888a0;
            --text-muted: #555566;
            --border: rgba(255,255,255,0.08);
            --accent: #6366f1;
            --accent-glow: rgba(99,102,241,0.3);
            --intent-info: #3b82f6;
            --intent-commercial: #f59e0b;
            --intent-trans: #10b981;
            --intent-nav: #8b5cf6;
            --intent-local: #ef4444;
            --entity-dominant: #fbbf24;
            --entity-bridge: #ec4899;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        
        .header { height: 56px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-weight: 700; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent), #a855f7); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .stats { display: flex; gap: 1.5rem; font-size: 0.75rem; color: var(--text-secondary); }
        .stat-val { font-weight: 700; color: var(--text-primary); margin-left: 0.3rem; }
        
        .tabs { display: flex; background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 0 1.5rem; }
        .tab { padding: 0.7rem 1.2rem; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .main { display: grid; grid-template-columns: 300px 1fr 320px; height: calc(100vh - 96px); }
        .sidebar { background: var(--bg-secondary); border-right: 1px solid var(--border); padding: 1rem; overflow-y: auto; }
        .sidebar-right { border-right: none; border-left: 1px solid var(--border); }
        .section-title { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.7rem; }
        
        .input-box { background: var(--bg-tertiary); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; }
        .input-box textarea { width: 100%; min-height: 100px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; padding: 0.7rem; color: var(--text-primary); font-size: 0.85rem; resize: vertical; }
        .input-box textarea:focus { outline: none; border-color: var(--accent); }
        .btn { width: 100%; padding: 0.7rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: none; background: linear-gradient(135deg, var(--accent), #a855f7); color: white; margin-top: 0.75rem; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 8px 20px -8px var(--accent-glow); }
        
        .filter-pills { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 1rem; }
        .pill { padding: 0.35rem 0.6rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-secondary); }
        .pill.active { background: var(--accent); border-color: var(--accent); color: white; }
        
        .view-content { background: var(--bg-primary); position: relative; overflow: hidden; }
        .view-panel { display: none; width: 100%; height: 100%; }
        .view-panel.active { display: block; }
        #galaxy-svg { width: 100%; height: 100%; }
        
        .why-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; display: none; }
        .why-panel.visible { display: block; }
        .why-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; }
        .why-close { cursor: pointer; color: var(--text-muted); }
        .why-row { display: flex; justify-content: space-between; font-size: 0.75rem; padding: 0.25rem 0; border-bottom: 1px solid var(--border); }
        .why-label { color: var(--text-secondary); }
        .gravity-bar { display: flex; gap: 2px; margin-top: 0.5rem; }
        .gravity-segment { height: 6px; border-radius: 2px; }
        
        .list-view { padding: 1.5rem; overflow-y: auto; height: 100%; }
        .card { background: var(--bg-card); border-radius: 10px; border: 1px solid var(--border); padding: 1rem; margin-bottom: 0.75rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .card-title { font-weight: 700; font-size: 0.9rem; }
        .badge { padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
        .badge-role { background: var(--accent); }
        .badge-dominant { background: var(--entity-dominant); color: #000; }
        .badge-bridge { background: var(--entity-bridge); }
        .card-meta { font-size: 0.75rem; color: var(--text-secondary); }
        .card-reasons { margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted); }
        
        .serp-card { border-left: 4px solid var(--intent-info); }
        .gap-card { border-left: 4px solid var(--intent-commercial); }
        
        .zoom-controls { position: absolute; bottom: 1rem; right: 1rem; display: flex; gap: 0.4rem; }
        .zoom-btn { width: 32px; height: 32px; border-radius: 6px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); cursor: pointer; font-size: 1rem; }
        .zoom-btn:hover { background: var(--accent); }
        
        .loading { position: absolute; inset: 0; background: rgba(10,10,15,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .loading.visible { display: flex; }
        .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty { text-align: center; padding: 3rem; color: var(--text-muted); }
        .empty-icon { font-size: 3rem; margin-bottom: 0.5rem; opacity: 0.5; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo"><div class="logo-icon">üåå</div><span>Entity & Cluster Intelligence <span style="color:var(--accent)">v3.0</span></span></div>
        <div class="stats">
            <span>Keywords:<span class="stat-val" id="s-kw">0</span></span>
            <span>Entities:<span class="stat-val" id="s-ent">0</span></span>
            <span>Clusters:<span class="stat-val" id="s-clust">0</span></span>
            <span>Gaps:<span class="stat-val" id="s-gap">0</span></span>
        </div>
    </header>
    
    <nav class="tabs">
        <div class="tab" data-view="upload">üì§ Upload</div>
        <div class="tab active" data-view="galaxy">üåå Galaxy</div>
        <div class="tab" data-view="serp">üåê SERP Alignment</div>
        <div class="tab" data-view="gaps">‚ùó Gap Analysis</div>
        <div class="tab" data-view="roles">üè∑Ô∏è Cluster Roles</div>
    </nav>
    
    <div class="main">
        <aside class="sidebar">
            <div class="section-title">üì• Seed Keywords</div>
            <div class="input-box">
                <textarea id="input" placeholder="Enter keywords (one per line)&#10;&#10;elgitarr&#10;b√§sta elgitarr&#10;k√∂pa elgitarr"></textarea>
                <label style="display:flex;align-items:center;gap:0.4rem;font-size:0.8rem;margin-top:0.5rem;color:var(--text-secondary)">
                    <input type="checkbox" id="expand-check" checked> Expand via Autocomplete
                </label>
                <button class="btn" onclick="runAnalysis()">üöÄ Analyze</button>
            </div>
            
            <div class="section-title">üéØ Filter Intent</div>
            <div class="filter-pills" id="intent-filters">
                <div class="pill active" data-intent="all">All</div>
                <div class="pill" data-intent="informational">Info</div>
                <div class="pill" data-intent="commercial">Commercial</div>
                <div class="pill" data-intent="transactional">Trans</div>
            </div>
            
            <div class="section-title">‚≠ê Dominant Entities</div>
            <div id="dominant-list" style="font-size:0.8rem;color:var(--text-secondary)">Run analysis to see</div>
            
            <div class="section-title" style="margin-top:1rem">üîó Bridge Entities</div>
            <div id="bridge-list" style="font-size:0.8rem;color:var(--text-secondary)">Run analysis to see</div>
        </aside>
        
        <main class="view-content">
            <div class="view-panel" id="upload-panel">
                <div class="list-view" style="max-width:800px;margin:0 auto;">
                    <h2 style="margin-bottom:1.5rem;font-weight:700">üì§ Upload Ahrefs Data</h2>
                    
                    <div id="drop-zone" style="border:2px dashed var(--border);border-radius:12px;padding:3rem;text-align:center;cursor:pointer;transition:all 0.3s;background:var(--bg-card)">
                        <div style="font-size:3rem;opacity:0.5;margin-bottom:0.5rem">üìÅ</div>
                        <div style="font-size:0.9rem;color:var(--text-secondary)">Drag & drop Ahrefs CSV here</div>
                        <div style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem">or click to browse</div>
                        <input type="file" id="file-input" accept=".csv,.txt" style="display:none">
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1.5rem">
                        <div>
                            <label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.4rem">Domain</label>
                            <input type="text" id="upload-domain" placeholder="example.com" style="width:100%;padding:0.6rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary)">
                        </div>
                        <div>
                            <label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.4rem">Label</label>
                            <select id="upload-label" style="width:100%;padding:0.6rem;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary)">
                                <option value="mine">My Domain</option>
                                <option value="competitor">Competitor</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="uploadFile()" style="margin-top:1rem">üöÄ Process Import</button>
                    
                    <div id="upload-result" style="margin-top:1.5rem;display:none;background:var(--bg-tertiary);border-radius:8px;padding:1rem">
                        <div style="font-weight:700;margin-bottom:0.5rem">‚úÖ Import Successful</div>
                        <div id="upload-info" style="font-size:0.8rem;color:var(--text-secondary)"></div>
                    </div>
                    
                    <div style="margin-top:2rem;border-top:1px solid var(--border);padding-top:1.5rem">
                        <div style="font-size:0.75rem;font-weight:700;color:var(--text-muted);margin-bottom:0.75rem">SUPPORTED FORMATS</div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;font-size:0.75rem;color:var(--text-secondary)">
                            <div>‚Ä¢ Organic Keywords</div><div>‚Ä¢ Content Gap</div><div>‚Ä¢ Keyword Explorer</div>
                            <div>‚Ä¢ Site Explorer</div><div>‚Ä¢ Top Pages</div><div>‚Ä¢ Backlinks</div>
                            <div>‚Ä¢ Referring Domains</div><div>‚Ä¢ Anchors</div><div>‚Ä¢ Simple keyword lists</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="view-panel active" id="galaxy-panel">
                <svg id="galaxy-svg"></svg>
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
                    <button class="zoom-btn" onclick="zoomReset()">‚ü≤</button>
                </div>
                <div class="empty" id="galaxy-empty"><div class="empty-icon">üåå</div><div>Enter keywords and analyze</div></div>
            </div>
            
            <div class="view-panel" id="serp-panel">
                <div class="list-view" id="serp-list"></div>
            </div>
            
            <div class="view-panel" id="gaps-panel">
                <div class="list-view" id="gaps-list"></div>
            </div>
            
            <div class="view-panel" id="roles-panel">
                <div class="list-view" id="roles-list"></div>
            </div>
            
            <div class="loading" id="loading"><div class="spinner"></div><div style="margin-top:1rem;font-size:0.85rem;color:var(--text-secondary)">Running pipeline...</div></div>
        </main>
        
        <aside class="sidebar sidebar-right">
            <div class="section-title">üìã Node Details</div>
            <div class="why-panel" id="why-panel">
                <div class="why-title"><span id="why-name"></span><span class="why-close" onclick="closeWhyPanel()">‚úï</span></div>
                <div id="why-content"></div>
            </div>
            <div id="why-empty" style="font-size:0.8rem;color:var(--text-secondary)">Click a node in Galaxy to see details</div>
            
            <div class="section-title" style="margin-top:1.5rem">üìä Gravity Formula</div>
            <div style="font-size:0.7rem;color:var(--text-muted);background:var(--bg-tertiary);padding:0.75rem;border-radius:8px;font-family:monospace">
                semantic_mass =<br>
                &nbsp;0.45 √ó cluster_mass +<br>
                &nbsp;0.20 √ó bridge_mass +<br>
                &nbsp;0.20 √ó centrality_mass +<br>
                &nbsp;0.15 √ó serp_mass
            </div>
        </aside>
    </div>

<script>
let data = null, svg, g, zoom, simulation;
let activeView = 'galaxy', activeIntent = 'all';

const COLORS = { informational:'#3b82f6', commercial:'#f59e0b', transactional:'#10b981', navigational:'#8b5cf6', local:'#ef4444', mixed:'#6b7280' };

function init() {
    const c = document.getElementById('galaxy-panel');
    svg = d3.select('#galaxy-svg').attr('width', c.clientWidth).attr('height', c.clientHeight);
    g = svg.append('g');
    zoom = d3.zoom().scaleExtent([0.1,4]).on('zoom', e => g.attr('transform', e.transform));
    svg.call(zoom);
    
    document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => switchView(t.dataset.view)));
    document.querySelectorAll('#intent-filters .pill').forEach(p => p.addEventListener('click', () => {
        document.querySelectorAll('#intent-filters .pill').forEach(x => x.classList.remove('active'));
        p.classList.add('active');
        activeIntent = p.dataset.intent;
        if (data) renderGalaxy();
    }));
}

function switchView(v) {
    activeView = v;
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.view === v));
    document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
    document.getElementById(v + '-panel').classList.add('active');
}

async function runAnalysis() {
    const input = document.getElementById('input').value;
    if (!input.trim()) return alert('Enter keywords');
    const keywords = input.split('\n').filter(k => k.trim());
    const expand = document.getElementById('expand-check').checked;
    
    document.getElementById('loading').classList.add('visible');
    
    try {
        const resp = await fetch('http://localhost:8001/analyze/full', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ keywords, expand })
        });
        data = await resp.json();
    } catch (e) {
        console.log('API unavailable, using mock');
        data = mockData(keywords, expand);
    }
    
    updateStats();
    renderGalaxy();
    renderSerp();
    renderGaps();
    renderRoles();
    document.getElementById('galaxy-empty').style.display = 'none';
    document.getElementById('loading').classList.remove('visible');
}

function mockData(seeds, expand) {
    const nodes = [], links = [];
    const intents = ['informational','commercial','transactional','mixed'];
    
    seeds.forEach((s, i) => {
        const intent = intents[i % intents.length];
        nodes.push({ id: `kw_${i}`, label: s, type: 'keyword', intent, isSeed: true, size: 10 });
    });
    
    if (expand) {
        const exps = ['b√§sta','test','k√∂pa','pris','guide'];
        seeds.forEach((s, si) => {
            exps.slice(0, 3).forEach((e, ei) => {
                const id = `kw_exp_${si}_${ei}`;
                const intent = intents[(si + ei) % intents.length];
                nodes.push({ id, label: `${e} ${s}`, type: 'keyword', intent, isSeed: false, size: 6 });
                links.push({ source: `kw_${si}`, target: id, weight: 0.5 });
            });
        });
    }
    
    const entityNames = seeds.map(s => s.split(' ').pop());
    entityNames.forEach((name, i) => {
        const sm = 0.3 + Math.random() * 0.7;
        nodes.push({
            id: `ent_${i}`, label: name.charAt(0).toUpperCase() + name.slice(1), type: 'entity',
            semanticMass: sm, isDominant: sm > 0.6, isBridge: Math.random() > 0.7,
            gravityComponents: { cluster: sm * 0.8, bridge: Math.random() * 0.5, centrality: Math.random() * 0.4, serp: Math.random() * 0.3 },
            size: 14 + sm * 15
        });
        nodes.filter(n => n.type === 'keyword').slice(0, 4).forEach(kw => {
            links.push({ source: kw.id, target: `ent_${i}`, weight: 0.6 });
        });
    });
    
    return {
        galaxy: { nodes, links },
        serpAlignment: { alignments: seeds.map((s, i) => ({
            keyword: s, role: ['educator','comparator','selector'][i % 3], roleConfidence: 70 + Math.random() * 25,
            shape: ['guide','listicle','comparison_table'][i % 3], shapeConfidence: 65 + Math.random() * 30,
            homogeneity: 50 + Math.random() * 40, dominantEntities: [entityNames[i % entityNames.length]]
        }))},
        gaps: { gaps: [{ name: `Commercial cluster for ${entityNames[0]}`, keywords: [`b√§sta ${seeds[0]}`], targetEntity: entityNames[0], priority: 0.85, reason: 'Missing commercial intent' }] },
        stats: { total_keywords: nodes.filter(n => n.type === 'keyword').length, entity_count: entityNames.length, cluster_count: 4, gap_count: 1, dominant_entities: entityNames.slice(0,2), bridge_entities: [] }
    };
}

function updateStats() {
    document.getElementById('s-kw').textContent = data.stats.total_keywords || 0;
    document.getElementById('s-ent').textContent = data.stats.entity_count || 0;
    document.getElementById('s-clust').textContent = data.stats.cluster_count || 0;
    document.getElementById('s-gap').textContent = data.stats.gap_count || 0;
    
    document.getElementById('dominant-list').innerHTML = (data.stats.dominant_entities || []).map(e => `<div style="padding:0.3rem 0">‚≠ê ${e}</div>`).join('') || '<div style="color:var(--text-muted)">None</div>';
    document.getElementById('bridge-list').innerHTML = (data.stats.bridge_entities || []).map(e => `<div style="padding:0.3rem 0">üîó ${e}</div>`).join('') || '<div style="color:var(--text-muted)">None</div>';
}

function renderGalaxy() {
    g.selectAll('*').remove();
    const c = document.getElementById('galaxy-panel');
    const w = c.clientWidth, h = c.clientHeight;
    
    let nodes = data.galaxy.nodes;
    if (activeIntent !== 'all') nodes = nodes.filter(n => n.type === 'entity' || n.intent === activeIntent);
    const nodeIds = new Set(nodes.map(n => n.id));
    let links = data.galaxy.links.filter(l => nodeIds.has(l.source.id || l.source) && nodeIds.has(l.target.id || l.target));
    
    simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(70))
        .force('charge', d3.forceManyBody().strength(-180))
        .force('center', d3.forceCenter(w/2, h/2))
        .force('collision', d3.forceCollide().radius(d => d.size + 4));
    
    g.append('g').selectAll('line').data(links).join('line')
        .attr('stroke', '#333').attr('stroke-opacity', d => d.weight * 0.7).attr('stroke-width', d => d.weight * 2);
    
    const node = g.append('g').selectAll('g').data(nodes).join('g')
        .call(d3.drag().on('start', (e,d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
            .on('drag', (e,d) => { d.fx = e.x; d.fy = e.y; })
            .on('end', (e,d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }));
    
    node.append('circle')
        .attr('r', d => d.size)
        .attr('fill', d => d.type === 'entity' ? (d.isDominant ? '#fbbf24' : d.isBridge ? '#ec4899' : '#6366f1') : COLORS[d.intent] || '#6b7280')
        .attr('stroke', d => d.type === 'entity' ? '#fff' : 'none')
        .attr('stroke-width', d => d.type === 'entity' ? 2 : 0)
        .style('cursor', 'pointer')
        .on('click', (e, d) => showWhyPanel(d));
    
    node.append('text').text(d => d.label.length > 16 ? d.label.slice(0,14)+'...' : d.label)
        .attr('x', 0).attr('y', d => d.size + 10).attr('text-anchor', 'middle').attr('font-size', '8px').attr('fill', '#777');
    
    simulation.on('tick', () => {
        g.selectAll('line').attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y);
        node.attr('transform', d => `translate(${d.x},${d.y})`);
    });
}

function showWhyPanel(d) {
    const panel = document.getElementById('why-panel');
    const content = document.getElementById('why-content');
    document.getElementById('why-name').textContent = d.label;
    document.getElementById('why-empty').style.display = 'none';
    panel.classList.add('visible');
    
    let html = `<div class="why-row"><span class="why-label">Type</span><span>${d.type}</span></div>`;
    
    if (d.type === 'keyword') {
        html += `<div class="why-row"><span class="why-label">Intent</span><span style="color:${COLORS[d.intent]}">${d.intent}</span></div>`;
        html += `<div class="why-row"><span class="why-label">Seed</span><span>${d.isSeed ? 'Yes' : 'No'}</span></div>`;
    } else if (d.type === 'entity') {
        html += `<div class="why-row"><span class="why-label">Semantic Mass</span><span>${(d.semanticMass * 100).toFixed(0)}%</span></div>`;
        html += `<div class="why-row"><span class="why-label">Dominant</span><span>${d.isDominant ? '‚≠ê Yes' : 'No'}</span></div>`;
        html += `<div class="why-row"><span class="why-label">Bridge</span><span>${d.isBridge ? 'üîó Yes' : 'No'}</span></div>`;
        
        if (d.gravityComponents) {
            const gc = d.gravityComponents;
            html += `<div style="margin-top:0.5rem;font-size:0.7rem;color:var(--text-muted)">Gravity Breakdown:</div>`;
            html += `<div class="gravity-bar">`;
            html += `<div class="gravity-segment" style="width:${gc.cluster*60}px;background:#3b82f6" title="Cluster ${(gc.cluster*100).toFixed(0)}%"></div>`;
            html += `<div class="gravity-segment" style="width:${gc.bridge*60}px;background:#ec4899" title="Bridge ${(gc.bridge*100).toFixed(0)}%"></div>`;
            html += `<div class="gravity-segment" style="width:${gc.centrality*60}px;background:#10b981" title="Centrality ${(gc.centrality*100).toFixed(0)}%"></div>`;
            html += `<div class="gravity-segment" style="width:${gc.serp*60}px;background:#f59e0b" title="SERP ${(gc.serp*100).toFixed(0)}%"></div>`;
            html += `</div>`;
            html += `<div style="display:flex;gap:0.5rem;font-size:0.6rem;color:var(--text-muted);margin-top:0.3rem">`;
            html += `<span style="color:#3b82f6">C:${(gc.cluster*100).toFixed(0)}%</span>`;
            html += `<span style="color:#ec4899">B:${(gc.bridge*100).toFixed(0)}%</span>`;
            html += `<span style="color:#10b981">Cn:${(gc.centrality*100).toFixed(0)}%</span>`;
            html += `<span style="color:#f59e0b">S:${(gc.serp*100).toFixed(0)}%</span>`;
            html += `</div>`;
        }
    }
    content.innerHTML = html;
}

function closeWhyPanel() {
    document.getElementById('why-panel').classList.remove('visible');
    document.getElementById('why-empty').style.display = 'block';
}

function renderSerp() {
    const list = document.getElementById('serp-list');
    if (!data.serpAlignment || !data.serpAlignment.alignments.length) {
        list.innerHTML = '<div class="empty"><div class="empty-icon">üåê</div>No SERP data</div>';
        return;
    }
    list.innerHTML = data.serpAlignment.alignments.map(a => `
        <div class="card serp-card">
            <div class="card-header">
                <span class="card-title">${a.keyword}</span>
                <span class="badge" style="background:var(--intent-info)">${a.role}</span>
            </div>
            <div class="card-meta">
                Shape: <strong>${a.shape}</strong> (${a.shapeConfidence.toFixed(0)}%) &nbsp;|&nbsp;
                Homogeneity: <strong>${a.homogeneity.toFixed(0)}%</strong>
            </div>
            <div class="card-reasons" style="margin-top:0.5rem">
                Dominant entities: ${(a.dominantEntities || []).join(', ') || 'None detected'}
            </div>
        </div>
    `).join('');
}

function renderGaps() {
    const list = document.getElementById('gaps-list');
    if (!data.gaps || !data.gaps.gaps.length) {
        list.innerHTML = '<div class="empty"><div class="empty-icon">‚úÖ</div>No gaps found - good coverage!</div>';
        return;
    }
    
    // Sort by priority
    const sorted = [...data.gaps.gaps].sort((a,b) => b.priority - a.priority);
    
    let html = `<div style="margin-bottom:1.5rem">
        <h2 style="font-weight:700;margin-bottom:0.5rem">Gap Analysis</h2>
        <div style="font-size:0.8rem;color:var(--text-secondary)">${sorted.length} gaps found ‚Ä¢ Sorted by priority</div>
    </div>
    <div style="display:grid;gap:0.75rem">`;
    
    sorted.forEach((g, i) => {
        const priorityColor = g.priority > 0.7 ? '#ef4444' : g.priority > 0.4 ? '#f59e0b' : '#10b981';
        html += `
        <div class="card gap-card" style="border-left-color:${priorityColor}">
            <div class="card-header">
                <span class="card-title" style="display:flex;align-items:center;gap:0.5rem">
                    <span style="background:${priorityColor};color:#fff;padding:0.15rem 0.4rem;border-radius:4px;font-size:0.65rem">#${i+1}</span>
                    ${g.name}
                </span>
                <span class="badge" style="background:${priorityColor}">${(g.priority * 100).toFixed(0)}%</span>
            </div>
            <div class="card-meta" style="margin:0.5rem 0">
                <span style="display:inline-flex;align-items:center;gap:0.3rem">üéØ Target: <strong>${g.targetEntity}</strong></span>
            </div>
            <div class="card-reasons">${g.reason}</div>
            <div style="margin-top:0.75rem;padding-top:0.5rem;border-top:1px solid var(--border)">
                <div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:0.4rem">Keywords to target:</div>
                <div style="display:flex;flex-wrap:wrap;gap:0.3rem">
                    ${g.keywords.map(k => `<span style="background:var(--bg-tertiary);padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem">${k}</span>`).join('')}
                </div>
            </div>
        </div>`;
    });
    
    html += '</div>';
    list.innerHTML = html;
}

function renderRoles() {
    const list = document.getElementById('roles-list');
    if (!data.galaxy || !data.galaxy.nodes) {
        list.innerHTML = '<div class="empty">No role data</div>';
        return;
    }
    const clusters = data.galaxy.nodes.filter(n => n.type === 'cluster');
    if (!clusters.length) {
        list.innerHTML = '<div class="empty"><div class="empty-icon">üè∑Ô∏è</div>Cluster roles shown in Galaxy view</div>';
        return;
    }
    list.innerHTML = clusters.map(c => `
        <div class="card">
            <div class="card-header">
                <span class="card-title">${c.label}</span>
                <span class="badge badge-role">${c.role}</span>
            </div>
            <div class="card-meta">Confidence: ${(c.roleConfidence * 100).toFixed(0)}%</div>
            <div class="card-reasons">${(c.reasons || []).join(' ‚Ä¢ ')}</div>
        </div>
    `).join('');
}

function zoomIn() { svg.transition().call(zoom.scaleBy, 1.4); }
function zoomOut() { svg.transition().call(zoom.scaleBy, 0.7); }
function zoomReset() { svg.transition().call(zoom.transform, d3.zoomIdentity); }

// Upload functionality
let uploadedFile = null;

function initUpload() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = 'var(--accent)'; });
    dropZone.addEventListener('dragleave', () => dropZone.style.borderColor = 'var(--border)');
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.style.borderColor = 'var(--border)';
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });
}

function handleFile(file) {
    uploadedFile = file;
    const dropZone = document.getElementById('drop-zone');
    dropZone.innerHTML = `<div style="font-size:2rem">üìÑ</div><div style="font-weight:700;margin-top:0.5rem">${file.name}</div><div style="font-size:0.75rem;color:var(--text-muted)">${(file.size/1024).toFixed(1)} KB</div>`;
}

async function uploadFile() {
    if (!uploadedFile) return alert('Please select a file first');
    const domain = document.getElementById('upload-domain').value;
    const label = document.getElementById('upload-label').value;
    if (!domain) return alert('Please enter a domain');
    
    const content = await uploadedFile.text();
    document.getElementById('loading').classList.add('visible');
    
    try {
        const resp = await fetch('http://localhost:8001/imports', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ file_content: content, domain, label })
        });
        const result = await resp.json();
        showUploadResult(result);
    } catch (e) {
        // Mock response for demo
        showUploadResult({ status: 'success', import_id: 'imp_demo123', report_type: 'organic_keywords', row_count: content.split('\n').length - 1 });
    }
    document.getElementById('loading').classList.remove('visible');
}

function showUploadResult(result) {
    const el = document.getElementById('upload-result');
    el.style.display = 'block';
    document.getElementById('upload-info').innerHTML = `
        <div>Import ID: <strong>${result.import_id}</strong></div>
        <div>Type: ${result.report_type || 'detected'}</div>
        <div>Rows: ${result.row_count}</div>
        <button class="btn" onclick="runAttribution('${result.import_id}')" style="margin-top:0.75rem;background:var(--intent-commercial)">‚ö° Run Attribution</button>
    `;
}

async function runAttribution(importId) {
    document.getElementById('loading').classList.add('visible');
    try {
        const resp = await fetch('http://localhost:8001/attribution/run', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ import_id: importId })
        });
        const result = await resp.json();
        alert(`Attribution complete! Job: ${result.job_id}, Results: ${result.result_count}`);
        switchView('gaps');
    } catch (e) {
        alert('Attribution complete (demo mode)');
        switchView('gaps');
    }
    document.getElementById('loading').classList.remove('visible');
}

window.addEventListener('load', () => { init(); initUpload(); });
window.addEventListener('resize', () => { if(svg) svg.attr('width', document.getElementById('galaxy-panel').clientWidth).attr('height', document.getElementById('galaxy-panel').clientHeight); });
</script>
</body>
</html>
